# 蓝牙设备发现与连接功能

## 实现的功能

### 1. 应用内蓝牙设备扫描
- ✅ 不再需要在手机设置中预先配对设备
- ✅ 在应用内直接扫描附近的蓝牙设备
- ✅ 显示设备名称、MAC地址和信号强度
- ✅ 自动区分已配对和未配对设备

### 2. 设备连接
- ✅ 点击设备即可直接连接，无需预先配对
- ✅ 支持 HC-05 等经典蓝牙模块
- ✅ 使用两种连接方式（标准 RFCOMM 和反射方法）提高兼容性
- ✅ 自动停止扫描以提高连接性能

### 3. 错误处理和提示
- ✅ 详细的错误信息显示
- ✅ 针对不同错误类型提供解决建议
- ✅ UI 中实时显示连接状态
- ✅ 连接失败时显示具体原因和建议

## 主要改进

### BluetoothManager.kt
1. **添加了设备发现功能**
   - `BluetoothDeviceInfo` 数据类：存储设备信息（名称、地址、配对状态、信号强度）
   - `startDiscovery()`: 开始扫描蓝牙设备
   - `stopDiscovery()`: 停止扫描
   - 使用 StateFlow 实时更新发现的设备列表

2. **BroadcastReceiver**
   - 监听 `ACTION_FOUND`: 发现新设备
   - 监听 `ACTION_DISCOVERY_STARTED`: 扫描开始
   - 监听 `ACTION_DISCOVERY_FINISHED`: 扫描结束
   - 自动按信号强度排序设备列表

3. **改进的连接方法**
   - 接受 `BluetoothDeviceInfo` 参数而不是 `BluetoothDevice`
   - 连接前自动停止扫描
   - 详细的错误信息和解决建议

### MainActivity.kt
1. **设备选择对话框**
   - 显示扫描按钮（可开始/停止扫描）
   - 实时显示扫描进度（圆形进度指示器）
   - 列表显示所有发现的设备
   - 已配对设备显示绿色标签
   - 显示信号强度（强/中/弱）

2. **错误对话框**
   - 显示错误标题和详细信息
   - 可滚动查看长错误消息
   - 提供针对性的解决建议

## 使用方法

1. **扫描设备**
   - 点击"连接设备"按钮
   - 在弹出的对话框中点击"扫描设备"
   - 等待扫描完成，设备将自动列出

2. **连接设备**
   - 从列表中选择要连接的设备
   - 等待连接完成
   - 连接成功后会显示"已连接: [设备名称]"
   - 连接失败会显示详细的错误信息

3. **查看错误信息**
   - 如果连接失败，会自动弹出错误对话框
   - 显示错误原因和可能的解决方法
   - 根据提示检查设备状态

## 常见问题解决

### 设备拒绝连接
- 检查设备是否开启
- 确认 HC-05 模块是否上电
- 检查设备是否正在与其他设备连接

### 连接超时
- 靠近蓝牙设备
- 检查是否有信号干扰
- 尝试重新扫描

### 设备忙碌
- 关闭其他使用蓝牙的应用
- 在系统设置中断开该设备
- 重启手机蓝牙

## 技术细节

### 权限要求
- Android 12+ (API 31+):
  - `BLUETOOTH_CONNECT`
  - `BLUETOOTH_SCAN`
- Android 11 及以下:
  - `BLUETOOTH`
  - `BLUETOOTH_ADMIN`

### 连接方法
1. 标准 RFCOMM: `createRfcommSocketToServiceRecord()`
2. 反射方法: `createRfcommSocket(1)` - 适用于某些不支持标准方法的设备

### UUID
使用标准串口 UUID: `00001101-0000-1000-8000-00805F9B34FB`

## 注意事项

1. 扫描会消耗电量，不使用时应停止扫描
2. 连接时会自动停止扫描以提高性能
3. 关闭应用时会自动清理资源（停止扫描、注销接收器）
4. 某些设备可能需要先配对才能连接（由设备决定）

